<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SANCHAY Airdrop Tool (Final Fix)</title>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0fff6; text-align: center; }
    input, button { padding: 10px; margin: 10px; width: 80%; max-width: 400px; font-size: 16px; }
    table { margin: auto; border-collapse: collapse; width: 90%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #d0f5e2; }
    .log { margin-top: 20px; white-space: pre-wrap; text-align: left; background: #eaffec; padding: 10px; border-radius: 8px; max-width: 800px; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>
  <h1>SANCHAY Airdrop Tool (SCY Token)</h1>
  <button id="connectBtn">Connect Phantom Wallet</button>
  <p id="walletAddress">Wallet not connected</p>
  <input type="file" id="csvFile" accept=".csv">
  <button id="loadBtn">Prepare Airdrop Table</button>
  <button id="startBtn">Start Airdrop</button>

  <table id="airdropTable">
    <thead><tr><th>#</th><th>Wallet</th><th>Amount</th><th>Status</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="log" id="logBox"></div>

  <script>
    window.onload = function () {
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const MINT_ADDRESS = new solanaWeb3.PublicKey("EaeryGrfbM4R3p133WV5SF3jNG1Dh1oL6V9igYp7q1FD");
      const TOKEN_PROGRAM_ID = splToken.TOKEN_PROGRAM_ID;
      const ASSOCIATED_TOKEN_PROGRAM_ID = splToken.ASSOCIATED_TOKEN_PROGRAM_ID;

      let walletPublicKey = null;
      let provider = window.solana;
      let entries = [];

      function log(msg) {
        const box = document.getElementById("logBox");
        box.textContent += msg + "\n";
      }

      async function connectWallet() {
        if (!provider?.isPhantom) {
          alert("Phantom Wallet not found");
          return;
        }
        try {
          const resp = await provider.connect();
          walletPublicKey = resp.publicKey;
          document.getElementById("walletAddress").textContent = `Connected: ${walletPublicKey.toBase58()}`;
          log("Wallet connected successfully.");
        } catch (err) {
          log("Connection failed: " + err.message);
        }
      }

      function loadCSV() {
        const file = document.getElementById("csvFile").files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const lines = e.target.result.trim().split("\n");
          const table = document.getElementById("tableBody");
          table.innerHTML = "";
          entries = lines.map((line, index) => {
            const [address, amount] = line.split(",");
            const row = table.insertRow();
            row.insertCell(0).textContent = index + 1;
            row.insertCell(1).textContent = address.trim();
            row.insertCell(2).textContent = amount.trim();
            row.insertCell(3).textContent = "Pending";
            return { address: address.trim(), amount: parseFloat(amount), statusCell: row.cells[3] };
          });
          log(`${entries.length} entries loaded.`);
        };
        reader.readAsText(file);
      }

      async function startAirdrop() {
        if (!walletPublicKey) return log("Connect your wallet first.");
        const senderTokenAccount = await splToken.getAssociatedTokenAddress(MINT_ADDRESS, walletPublicKey);
        log("Starting airdrop of SCY token...");

        for (let i = 0; i < entries.length; i++) {
          const entry = entries[i];
          try {
            const recipient = new solanaWeb3.PublicKey(entry.address);
            const recipientATA = await splToken.getAssociatedTokenAddress(MINT_ADDRESS, recipient);

            const instructions = [];
            const recipientInfo = await connection.getAccountInfo(recipientATA);
            if (!recipientInfo) {
              instructions.push(
                splToken.createAssociatedTokenAccountInstruction(
                  walletPublicKey,
                  recipientATA,
                  recipient,
                  MINT_ADDRESS
                )
              );
            }

            instructions.push(
              splToken.createTransferInstruction(
                senderTokenAccount,
                recipientATA,
                walletPublicKey,
                entry.amount
              )
            );

            const transaction = new solanaWeb3.Transaction().add(...instructions);
            transaction.feePayer = walletPublicKey;
            transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

            const signed = await provider.signTransaction(transaction);
            const signature = await connection.sendRawTransaction(signed.serialize());
            await connection.confirmTransaction(signature);

            entry.statusCell.textContent = "Sent";
            log(`Sent ${entry.amount} SCY to ${entry.address}`);
          } catch (err) {
            entry.statusCell.textContent = "Failed";
            log(`Failed for ${entry.address}: ${err.message}`);
          }
        }
      }

      document.getElementById("connectBtn").addEventListener("click", connectWallet);
      document.getElementById("loadBtn").addEventListener("click", loadCSV);
      document.getElementById("startBtn").addEventListener("click", startAirdrop);
    };
  </script>
</body>
</html>
