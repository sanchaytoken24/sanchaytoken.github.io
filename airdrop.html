<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SANCHAY Airdrop Tool V3 (Fixed)</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f7fdf9; padding: 20px; text-align: center; }
    h1 { color: #008f53; }
    input, button { margin: 10px; padding: 10px; width: 80%; max-width: 400px; font-size: 16px; }
    table { margin: 20px auto; width: 90%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
    th { background-color: #d0f0e9; }
    #output { margin-top: 20px; white-space: pre-wrap; font-family: monospace; background: #e6fff3; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>SANCHAY Airdrop Tool V3 (Updated)</h1>
  <p>Connect your Phantom wallet and upload your verified CSV to begin the airdrop.</p>

  <input type="file" id="fileInput" accept=".csv" />
  <br>
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <button onclick="prepareTransfers()">Prepare Airdrop Table</button>
  <button onclick="startTransfers()">Start Airdrop</button>

  <div id="output"></div>

  <table id="transferTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Wallet</th>
        <th>Amount</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
    const SCY_MINT = new solanaWeb3.PublicKey('EaeryGrfbM4R3p133WV5SF3jNG1Dh1oL6V9igYp7q1FD');
    let wallet = null;
    let entries = [];

    function log(msg) {
      const out = document.getElementById('output');
      out.textContent += msg + "\n";
    }

    async function connectWallet() {
      try {
        const resp = await window.solana.connect();
        wallet = resp.publicKey;
        log(`Connected wallet: ${wallet.toBase58()}`);
      } catch (err) {
        log("Phantom Wallet connection failed: " + err.message);
      }
    }

    function prepareTransfers() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return log("Please upload a CSV file");

      const reader = new FileReader();
      reader.onload = (e) => {
        const lines = e.target.result.trim().split('\n');
        entries = lines.map((line, i) => {
          const [address, amount] = line.split(',');
          return { index: i + 1, address: address.trim(), amount: parseFloat(amount), status: 'Pending' };
        });
        log(`Loaded ${entries.length} entries from CSV`);
        renderTable();
      };
      reader.readAsText(file);
    }

    function renderTable() {
      const body = document.getElementById('tableBody');
      body.innerHTML = '';
      entries.forEach((entry, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.index}</td>
          <td>${entry.address}</td>
          <td>${entry.amount}</td>
          <td id="status-${i}">${entry.status}</td>
        `;
        body.appendChild(row);
      });
    }

    async function startTransfers() {
      if (!wallet) return log("Please connect Phantom wallet first.");
      const token = new splToken.Token(connection, SCY_MINT, splToken.TOKEN_PROGRAM_ID, wallet);

      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        try {
          const toPubKey = new solanaWeb3.PublicKey(entry.address);
          const senderATA = await splToken.Token.getAssociatedTokenAddress(
            splToken.ASSOCIATED_TOKEN_PROGRAM_ID, splToken.TOKEN_PROGRAM_ID, SCY_MINT, wallet
          );
          const recipientATA = await splToken.Token.getAssociatedTokenAddress(
            splToken.ASSOCIATED_TOKEN_PROGRAM_ID, splToken.TOKEN_PROGRAM_ID, SCY_MINT, toPubKey
          );

          const recipientInfo = await connection.getAccountInfo(recipientATA);
          const tx = new solanaWeb3.Transaction();

          if (!recipientInfo) {
            tx.add(
              splToken.Token.createAssociatedTokenAccountInstruction(
                wallet, recipientATA, toPubKey, SCY_MINT
              )
            );
          }

          tx.add(
            splToken.Token.createTransferInstruction(
              splToken.TOKEN_PROGRAM_ID, senderATA, recipientATA, wallet, [], entry.amount
            )
          );

          tx.feePayer = wallet;
          tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;
          const signed = await window.solana.signTransaction(tx);
          const sig = await connection.sendRawTransaction(signed.serialize());
          await connection.confirmTransaction(sig);

          entry.status = 'Sent';
          document.getElementById(`status-${i}`).textContent = 'Sent';
        } catch (err) {
          entry.status = 'Failed';
          document.getElementById(`status-${i}`).textContent = 'Failed';
          log(`Error for ${entry.address}: ${err.message}`);
        }
      }
    }
  </script>
</body>
</html>
