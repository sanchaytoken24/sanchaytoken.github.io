<!DOCTYPE html>
<html>
<head>
  <title>SANCHAY Airdrop Debug v2</title>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.5/lib/index.iife.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5fff7; text-align: center; padding: 20px; }
    button, input { padding: 10px; margin: 10px; font-size: 16px; }
    table { margin: auto; border-collapse: collapse; width: 95%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
    th { background: #d0f5e2; }
    .log { background: #eaffec; padding: 10px; margin-top: 20px; max-width: 90%; margin-left: auto; margin-right: auto; white-space: pre-wrap; text-align: left; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>SANCHAY Airdrop Tool (Debug Mode)</h1>
  <button id="connect">Connect Phantom</button>
  <p id="status">Wallet not connected</p>
  <input type="file" id="fileInput" accept=".csv">
  <button id="load">Load CSV</button>
  <button id="start">Start Airdrop</button>

  <table>
    <thead><tr><th>#</th><th>Wallet</th><th>Amount</th><th>Status</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="log" id="logBox"></div>

  <script>
    window.onload = () => {
      const splToken = window.splToken; // Fix ReferenceError
      const provider = window.solana;
      const status = document.getElementById("status");
      const connectBtn = document.getElementById("connect");
      const loadBtn = document.getElementById("load");
      const startBtn = document.getElementById("start");
      const logBox = document.getElementById("logBox");
      const tableBody = document.getElementById("tableBody");
      const MINT = new solanaWeb3.PublicKey("EaeryGrfbM4R3p133WV5SF3jNG1Dh1oL6V9igYp7q1FD");

      let wallet = null;
      let connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"));
      let airdropList = [];

      const log = (msg) => {
        console.log(msg);
        logBox.textContent += msg + "\n";
      };

      connectBtn.onclick = async () => {
        try {
          const resp = await provider.connect();
          wallet = resp.publicKey;
          status.textContent = "Connected: " + wallet.toBase58();
          log("Wallet connected.");
        } catch (e) {
          status.textContent = "Connection failed.";
          log("Error: " + e.message);
        }
      };

      loadBtn.onclick = () => {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const lines = e.target.result.trim().split("\n");
          tableBody.innerHTML = "";
          airdropList = lines.map((line, i) => {
            const [addr, amt] = line.split(",");
            const row = tableBody.insertRow();
            row.insertCell(0).textContent = i + 1;
            row.insertCell(1).textContent = addr;
            row.insertCell(2).textContent = amt;
            row.insertCell(3).textContent = "Pending";
            return { address: addr.trim(), amount: parseFloat(amt), row };
          });
          log("Loaded " + airdropList.length + " entries.");
        };
        reader.readAsText(file);
      };

      startBtn.onclick = async () => {
        if (!wallet) return alert("Connect wallet first");

        log("Preparing to fetch source token account...");
        const fromTokenAcc = await splToken.getAssociatedTokenAddress(MINT, wallet);
        log("Source Token Account: " + fromTokenAcc.toBase58());

        for (let i = 0; i < airdropList.length; i++) {
          const entry = airdropList[i];
          try {
            const recipient = new solanaWeb3.PublicKey(entry.address);
            const toTokenAcc = await splToken.getAssociatedTokenAddress(MINT, recipient);
            const tx = new solanaWeb3.Transaction();

            const toInfo = await connection.getAccountInfo(toTokenAcc);
            if (!toInfo) {
              log(`Creating ATA for ${entry.address}`);
              tx.add(splToken.createAssociatedTokenAccountInstruction(wallet, toTokenAcc, recipient, MINT));
            }

            log(`Adding transfer: ${entry.amount} to ${entry.address}`);
            tx.add(splToken.createTransferInstruction(fromTokenAcc, toTokenAcc, wallet, entry.amount));
            tx.feePayer = wallet;
            tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

            const signed = await provider.signTransaction(tx);
            const sig = await connection.sendRawTransaction(signed.serialize());
            log(`Tx submitted: ${sig}`);

            await connection.confirmTransaction(sig);
            entry.row.cells[3].textContent = "Sent";
            log(`✅ Success: ${entry.amount} SCY sent to ${entry.address}`);
          } catch (e) {
            entry.row.cells[3].textContent = "Failed";
            log(`❌ Failed ${entry.address}: ${e.message}`);
          }
        }
      };
    };
  </script>
</body>
</html>
