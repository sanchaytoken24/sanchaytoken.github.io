<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SANCHAY Airdrop Tool V2</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #fdf6ec; padding: 20px; text-align: center; }
    h1 { color: #e79a00; }
    input, button { margin: 10px; padding: 10px; width: 80%; max-width: 400px; font-size: 16px; }
    table { margin: 20px auto; width: 90%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
    th { background-color: #ffe8b3; }
    #output { margin-top: 20px; white-space: pre-wrap; font-family: monospace; background: #fff3d4; padding: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>SANCHAY Airdrop Tool V2</h1>
  <p>Connect Phantom Wallet and send SCY tokens in batch with full control</p>

  <input type="file" id="fileInput" accept=".csv" />
  <br>
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <button onclick="prepareTransfers()">Prepare Airdrop Table</button>
  <button onclick="startTransfers()">Start Airdrop</button>

  <table id="transferTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Wallet Address</th>
        <th>Amount</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="output"></div>

  <script>
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
    const SCY_MINT = new solanaWeb3.PublicKey('EaeryGrfbM4R3p133WV5SF3jNG1Dh1oL6V9igYp7q1FD');
    let wallet = null;
    let entries = [];

    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        const resp = await window.solana.connect();
        wallet = resp.publicKey;
        log(`Connected to: ${wallet.toBase58()}`);
      } else {
        alert("Phantom Wallet not found");
      }
    }

    function prepareTransfers() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Please upload CSV file");
      const reader = new FileReader();
      reader.onload = (e) => {
        const lines = e.target.result.trim().split('\n');
        entries = lines.map((line, i) => {
          const [address, amount] = line.split(',');
          return { id: i + 1, address: address.trim(), amount: parseFloat(amount), status: 'Pending', skip: false };
        });
        renderTable();
      };
      reader.readAsText(file);
    }

    function renderTable() {
      const body = document.getElementById('tableBody');
      body.innerHTML = '';
      entries.forEach((entry, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.id}</td>
          <td>${entry.address}</td>
          <td>${entry.amount}</td>
          <td id="status-${i}">${entry.status}</td>
          <td><button onclick="toggleEntry(${i})">${entry.skip ? 'Undo' : 'Skip'}</button></td>
        `;
        body.appendChild(row);
      });
    }

    function toggleEntry(index) {
      entries[index].skip = !entries[index].skip;
      entries[index].status = entries[index].skip ? 'Skipped' : 'Pending';
      renderTable();
    }

    async function startTransfers() {
      if (!wallet) return alert("Connect wallet first");
      for (let i = 0; i < entries.length; i++) {
        const e = entries[i];
        if (e.skip || e.status !== 'Pending') continue;
        try {
          const tx = new solanaWeb3.Transaction();
          const senderATA = await findATA(wallet, SCY_MINT);
          const recipient = new solanaWeb3.PublicKey(e.address);
          const recipientATA = await findATA(recipient, SCY_MINT);

          const ix = solanaWeb3.Token.createTransferInstruction(
            solanaWeb3.TOKEN_PROGRAM_ID,
            senderATA,
            recipientATA,
            wallet,
            [],
            e.amount
          );

          tx.add(ix);
          tx.feePayer = wallet;
          const { blockhash } = await connection.getRecentBlockhash();
          tx.recentBlockhash = blockhash;
          const signed = await window.solana.signTransaction(tx);
          const sig = await connection.sendRawTransaction(signed.serialize());
          await connection.confirmTransaction(sig);

          e.status = 'Sent';
        } catch (err) {
          e.status = 'Failed';
          log(`Error sending to ${e.address}: ${err.message}`);
        }
        document.getElementById(`status-${i}`).textContent = e.status;
      }
    }

    async function findATA(owner, mint) {
      return (await solanaWeb3.PublicKey.findProgramAddress([
        owner.toBuffer(),
        solanaWeb3.TOKEN_PROGRAM_ID.toBuffer(),
        mint.toBuffer()
      ], new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5aVAkE79tCkq7zv9z3")).then(r => r[0]));
    }

    function log(msg) {
      document.getElementById('output').textContent += msg + '\n';
    }
  </script>
</body>
</html>
